services:
  proxy:
    image: traefik:v3.0
    container_name: h3-proxy
    command:
      - --api.insecure=true
      - --api.dashboard=true
      - --api.debug=true
      - --log.level=INFO
      - --accesslog=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=h3-proxy
      - --entrypoints.web.address=:80
    restart: always
    ports:
      - ${TRAEFIK_HOST_PORT80:-80}:80
      - ${TRAEFIK_HOST_PORT8080:-8080}:8080
    networks:
      - h3-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.proxy.rule=Host(`${PROXY_PATH:-proxy}.${PATH_SUFFIX:-localhost}`)
      - traefik.http.routers.proxy.entrypoints=web
      - traefik.http.routers.proxy.service=proxy
      - traefik.http.services.proxy.loadbalancer.server.port=8080

  app:
    image: hhh/app
    container_name: h3-app
    build: ./app
    restart: on-failure:3
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--no-warnings
      - MONGO_DB=surveyjs
      - MONGO_USER=admin
      - MONGO_PASSWORD=admin
      - MONGO_HOST=mongo
    user: root
    ports:
      - ${APP_HOST_PORT:-3000}:3000
    networks:
      - h3-proxy
    depends_on:
      - fuseki
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.app.rule=Host(`${APP_PATH:-app}.${PATH_SUFFIX:-localhost}`)
      - traefik.http.routers.app.entrypoints=web
      - traefik.http.routers.app.service=app
      - traefik.http.services.app.loadbalancer.server.port=3000
    develop:
      watch:
        - path: ./app
          action: rebuild

  fuseki:
    image: hhh/fuseki
    container_name: h3-fuseki
    build: ./fuseki
    restart: always
    env_file:
      - .env
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
    ports:
      - ${FUSEKI_HOST_PORT:-3030}:3030
    networks:
      - h3-proxy
    volumes:
      - fuseki-data:/fuseki
    depends_on:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.fuseki.rule=Host(`${FUSEKI_PATH:-fuseki}.${PATH_SUFFIX:-localhost}`)
      - traefik.http.routers.fuseki.entrypoints=web
      - traefik.http.routers.fuseki.service=fuseki
      - traefik.http.services.fuseki.loadbalancer.server.port=3030
  
  mongo:
    image: mongo
    container_name: h3-mongo
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin
      - MONGO_INITDB_DATABASE=surveyjs
    ports:
      - 27017:27017
    networks:
      - h3-proxy
    volumes:
      - ./mongo/entrypoint:/docker-entrypoint-initdb.d
      - ./mongo/data:/data/db
      - ./mongo/config:/data/configdb
    depends_on:
      - app

  translate:
    image: libretranslate/libretranslate:latest
    container_name: h3-translate
    restart: always
    ports:
      - ${LT_PORT:-5000}:5000
    volumes:
      - translate-data:/root/.local/share/argos-translate/packages
    networks:
      - h3-proxy
    env_file:
      - .env
    tty: true
    depends_on:
      - app
    labels:
      - traefik.enable=true
      - traefik.http.routers.translate.rule=Host(`${TRANSLATE_HOST:-translate}.${PATH_SUFFIX:-localhost}`)
      - traefik.http.routers.translate.entrypoints=web
      - traefik.http.routers.translate.service=translate
      - traefik.http.services.translate.loadbalancer.server.port=5000

  neo4j:
    image: neo4j:5
    container_name: h3-neo4j
    restart: unless-stopped
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-neo4j_password_change_me}
      - NEO4J_PLUGINS=["n10s"]
      - NEO4J_server_directories_import=/import
      - NEO4J_dbms_security_procedures_unrestricted=n10s.*
      - NEO4J_dbms_security_procedures_allowlist=n10s.*
    ports:
      - ${NEO4J_HTTP_PORT:-7474}:7474
      - ${NEO4J_BOLT_PORT:-7687}:7687
    networks:
      - h3-proxy
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - ./fuseki/init:/import:ro
    depends_on:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.neo4j.rule=Host(`neo4j.${PATH_SUFFIX:-localhost}`)
      - traefik.http.routers.neo4j.entrypoints=web
      - traefik.http.routers.neo4j.service=neo4j
      - traefik.http.services.neo4j.loadbalancer.server.port=7474

  backup:
    image: hhh/backup
    build: ./backup-service
    container_name: h3-backup
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-7}
    volumes:
      - ./backups:/backups
      - fuseki-data:/fuseki:ro
      - neo4j-data:/neo4j-data:ro
    networks:
      - h3-proxy
    depends_on:
      - mongo
      - fuseki
      - neo4j
    command: /bin/bash -c "while true; do /backup.sh && sleep 86400; done"

networks:
  h3-proxy:
    name: h3-proxy

volumes:
  fuseki-data:
    name: h3-fuseki-data
  translate-data:
    name: h3-translate-data
  neo4j-data:
    name: h3-neo4j-data
  neo4j-logs:
    name: h3-neo4j-logs
